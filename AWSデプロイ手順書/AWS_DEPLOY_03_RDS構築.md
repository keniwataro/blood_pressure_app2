# AWSデプロイ手順 Part 3: RDS（PostgreSQL）構築

## 目次
1. DBサブネットグループ作成
2. RDSインスタンス作成
3. 接続情報の確認

---

## 1. DBサブネットグループ作成

### 1-1. サブネットグループの作成
1. AWSコンソールで「RDS」を検索して開く
2. 左メニュー「サブネットグループ」→「DBサブネットグループを作成」
3. 以下を入力:
   - **名前**: `blood-pressure-db-subnet-group`
   - **説明**: `Subnet group for blood pressure app`
   - **VPC**: `blood-pressure-vpc`を選択
4. アベイラビリティーゾーンを追加:
   - **アベイラビリティーゾーン**: 2つのAZを選択（例: ap-northeast-1a, ap-northeast-1c）
   - **サブネット**: プライベートサブネット2つを選択
5. 「作成」をクリック

---

## 2. RDSインスタンス作成

### 2-1. データベースの作成
1. 左メニュー「データベース」→「データベースの作成」
2. **データベース作成方法**: 標準作成
3. **エンジンのオプション**:
   - **エンジンのタイプ**: PostgreSQL
   - **バージョン**: PostgreSQL 15.x（最新の安定版）
4. **テンプレート**: 本番稼働用（または開発/テスト用）
5. **可用性と耐久性**:
   - **シングル AZ DB インスタンスデプロイ (1 インスタンス)** を選択（開発/テスト用）
     - ※本番環境では「マルチ AZ DB インスタンスデプロイ (2 インスタンス)」を推奨（高可用性）
     - ※「マルチ AZ DB クラスターデプロイ (3 インスタンス)」は最高可用性が必要な場合のみ
6. **設定**:
   - **DBインスタンス識別子**: `blood-pressure-db`
   - **マスターユーザー名**: `postgres`
   - **認証情報管理**: 
     - **セルフマネージド** を選択（開発/テスト用）
     - ※本番環境では「AWS Secrets Manager で管理」を推奨（最も安全）
   - **マスターパスワード**: 強力なパスワードを設定（メモしておく）
   - **パスワードの確認**: 同じパスワードを再入力
6. **インスタンスの設定**:
   - **DBインスタンスクラス**: バースト可能クラス → db.t3.micro（無料枠対象）
   - **ストレージタイプ**: 汎用SSD (gp3)
   - **ストレージ割り当て**: 20 GiB
   - **ストレージの自動スケーリング**: 有効化（最大100 GiB）
7. **接続**:
   - **コンピューティングリソース**: EC2コンピューティングリソースに接続しない
   - **VPC**: `blood-pressure-vpc`を選択
   - **DBサブネットグループ**: `blood-pressure-db-subnet-group`を選択
   - **パブリックアクセス**: なし
   - **既存のVPCセキュリティグループ**: 既存を選択 → `blood-pressure-rds-sg`
   - **アベイラビリティーゾーン**: 指定なし
8. **データベース認証**:
   - **データベース認証オプション**: パスワード認証
9. **追加設定**を展開:
   - **初期データベース名**: `blood_pressure_production`
   - **バックアップ**: 自動バックアップを有効化（保持期間: 7日）
   - **暗号化**: 有効化
   - **ログのエクスポート**: PostgreSQLログ
   - **マイナーバージョン自動アップグレード**: 有効化
10. 「データベースの作成」をクリック

**作成には5〜10分かかります。**

---

## 3. 接続情報の確認

### 3-1. エンドポイントの確認
1. データベースのステータスが「利用可能」になるまで待つ
2. 作成したデータベース `blood-pressure-db` をクリック
3. 「接続とセキュリティ」タブで以下を確認:
   - **エンドポイント**: `blood-pressure-db.xxxxxxxxxx.ap-northeast-1.rds.amazonaws.com`
   - **ポート**: `5432`

### 3-2. 接続情報をメモ
以下の情報をメモしておく（後でECSで使用）:
```
DB_HOST: blood-pressure-db.xxxxxxxxxx.ap-northeast-1.rds.amazonaws.com
DB_PORT: 5432
DB_NAME: blood_pressure_production
DB_USER: postgres
DB_PASSWORD: （設定したパスワード）
```

---

## 次のステップ

RDS構築が完了したら、次のファイル「AWS_DEPLOY_04_ECR_S3構築.md」に進んでください。
