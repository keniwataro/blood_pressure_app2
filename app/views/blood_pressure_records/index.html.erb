<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h2">血圧記録</h1>
  <div>
    <%= link_to "CSV出力", blood_pressure_records_path(format: :csv),
        class: "btn btn-success me-2" %>
    <%= button_tag "CSV取り込み", type: "button", class: "btn btn-info me-2",
        data: { bs_toggle: "modal", bs_target: "#importModal" } %>
    <%= link_to "新しい記録を追加", new_blood_pressure_record_path,
        class: "btn btn-primary" %>
  </div>
</div>

<!-- 血圧記録テーブル -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">血圧記録</h5>
    <%= link_to "グラフ表示", charts_path, class: "btn btn-success btn-sm" %>
  </div>
  <div class="card-body">
    <% if @blood_pressure_records.any? %>
      <!-- 上部のページネーション -->
      <% if @total_pages > 1 %>
        <nav aria-label="ページネーション" class="mb-4">
          <ul class="pagination justify-content-center">
            <!-- 前へリンク -->
            <% if @current_page > 1 %>
              <li class="page-item">
                <%= link_to "前へ", blood_pressure_records_path(page: @current_page - 1), class: "page-link" %>
              </li>
            <% else %>
              <li class="page-item disabled">
                <span class="page-link">前へ</span>
              </li>
            <% end %>

            <!-- ページ番号リンク -->
            <% start_page = [@current_page - 2, 1].max %>
            <% end_page = [@current_page + 2, @total_pages].min %>

            <!-- 最初のページへのリンク（省略記号が必要な場合） -->
            <% if start_page > 1 %>
              <li class="page-item">
                <%= link_to "1", blood_pressure_records_path(page: 1), class: "page-link" %>
              </li>
              <% if start_page > 2 %>
                <li class="page-item disabled">
                  <span class="page-link">...</span>
                </li>
              <% end %>
            <% end %>

            <!-- 現在のページ周辺のページ番号 -->
            <% (start_page..end_page).each do |page| %>
              <li class="page-item <%= 'active' if page == @current_page %>">
                <%= link_to page, blood_pressure_records_path(page: page), class: "page-link" %>
              </li>
            <% end %>

            <!-- 最後のページへのリンク（省略記号が必要な場合） -->
            <% if end_page < @total_pages %>
              <% if end_page < @total_pages - 1 %>
                <li class="page-item disabled">
                  <span class="page-link">...</span>
                </li>
              <% end %>
              <li class="page-item">
                <%= link_to @total_pages, blood_pressure_records_path(page: @total_pages), class: "page-link" %>
              </li>
            <% end %>

            <!-- 次へリンク -->
            <% if @current_page < @total_pages %>
              <li class="page-item">
                <%= link_to "次へ", blood_pressure_records_path(page: @current_page + 1), class: "page-link" %>
              </li>
            <% else %>
              <li class="page-item disabled">
                <span class="page-link">次へ</span>
              </li>
            <% end %>
          </ul>
        </nav>

        <!-- ページ情報表示 -->
        <div class="text-center mb-3">
          <small class="text-muted">
            <%= @total_count %>件中 <%= ((@current_page - 1) * @per_page) + 1 %>-<%= [@current_page * @per_page, @total_count].min %>件を表示
          </small>
        </div>
      <% end %>

      <div class="d-md-none alert alert-info py-2 px-3 mb-2" style="font-size: 0.8rem;">
        <i class="bi bi-arrow-left-right"></i> 横にスクロールして全ての情報を確認できます
      </div>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>測定日時</th>
              <th>最高血圧</th>
              <th>最低血圧</th>
              <th>脈拍</th>
              <th>分類</th>
              <th>メモ</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <% @blood_pressure_records_paginated.each do |record| %>
              <tr>
                <td><%= record.measured_at.strftime("%Y/%m/%d %H:%M") %></td>
                <td>
                  <span class="<%= record.systolic_pressure >= 140 ? 'blood-pressure-high' : 'blood-pressure-normal' %>">
                    <%= record.systolic_pressure %> mmHg
                  </span>
                </td>
                <td>
                  <span class="<%= record.diastolic_pressure >= 90 ? 'blood-pressure-high' : 'blood-pressure-normal' %>">
                    <%= record.diastolic_pressure %> mmHg
                  </span>
                </td>
                <td><%= record.pulse_rate %> bpm</td>
                <td>
                  <span class="badge bg-<%= case record.blood_pressure_category
                                            when '正常血圧' then 'success'
                                            when '正常高値血圧' then 'info'
                                            when '軽症高血圧（Ⅰ度）' then 'warning'
                                            else 'danger'
                                            end %>">
                    <%= record.blood_pressure_category %>
                  </span>
                </td>
                <td>
                  <%= record.memo.presence || '-' %>
                </td>
                <td>
                  <%= link_to "詳細", record, class: "btn btn-sm btn-info" %>
                  <%= link_to "編集", edit_blood_pressure_record_path(record), class: "btn btn-sm btn-warning" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- 下部のページネーション -->
      <% if @total_pages > 1 %>
        <nav aria-label="ページネーション" class="mt-4">
          <ul class="pagination justify-content-center">
            <!-- 前へリンク -->
            <% if @current_page > 1 %>
              <li class="page-item">
                <%= link_to "前へ", blood_pressure_records_path(page: @current_page - 1), class: "page-link" %>
              </li>
            <% else %>
              <li class="page-item disabled">
                <span class="page-link">前へ</span>
              </li>
            <% end %>

            <!-- ページ番号リンク -->
            <% start_page = [@current_page - 2, 1].max %>
            <% end_page = [@current_page + 2, @total_pages].min %>

            <!-- 最初のページへのリンク（省略記号が必要な場合） -->
            <% if start_page > 1 %>
              <li class="page-item">
                <%= link_to "1", blood_pressure_records_path(page: 1), class: "page-link" %>
              </li>
              <% if start_page > 2 %>
                <li class="page-item disabled">
                  <span class="page-link">...</span>
                </li>
              <% end %>
            <% end %>

            <!-- 現在のページ周辺のページ番号 -->
            <% (start_page..end_page).each do |page| %>
              <li class="page-item <%= 'active' if page == @current_page %>">
                <%= link_to page, blood_pressure_records_path(page: page), class: "page-link" %>
              </li>
            <% end %>

            <!-- 最後のページへのリンク（省略記号が必要な場合） -->
            <% if end_page < @total_pages %>
              <% if end_page < @total_pages - 1 %>
                <li class="page-item disabled">
                  <span class="page-link">...</span>
                </li>
              <% end %>
              <li class="page-item">
                <%= link_to @total_pages, blood_pressure_records_path(page: @total_pages), class: "page-link" %>
              </li>
            <% end %>

            <!-- 次へリンク -->
            <% if @current_page < @total_pages %>
              <li class="page-item">
                <%= link_to "次へ", blood_pressure_records_path(page: @current_page + 1), class: "page-link" %>
              </li>
            <% else %>
              <li class="page-item disabled">
                <span class="page-link">次へ</span>
              </li>
            <% end %>
          </ul>
        </nav>

        <!-- ページ情報表示 -->
        <div class="text-center mb-3">
          <small class="text-muted">
            <%= @total_count %>件中 <%= ((@current_page - 1) * @per_page) + 1 %>-<%= [@current_page * @per_page, @total_count].min %>件を表示
          </small>
        </div>
      <% end %>
    <% else %>
      <div class="text-center py-5">
        <p class="text-muted mb-3">まだ血圧記録がありません。</p>
        <%= link_to "初回記録を追加", new_blood_pressure_record_path, class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
</div>

<!-- CSVインポートモーダル -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="importModalLabel">CSVファイル取り込み</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
      </div>
      <%= form_with url: import_blood_pressure_records_path, multipart: true, local: true do |f| %>
        <div class="modal-body">
          <div class="mb-3">
            <label for="csvFile" class="form-label">CSVファイルを選択</label>
            <%= f.file_field :file, accept: ".csv", class: "form-control", id: "csvFile", required: true %>
          </div>
          <div class="alert alert-info">
            <strong>CSVフォーマット:</strong><br>
            測定日時,最高血圧(mmHg),最低血圧(mmHg),脈拍(bpm),血圧分類,メモ<br>
            <small class="text-muted">※血圧分類は自動計算されるため、列は無視されます</small><br>
            <small class="text-muted">※測定日時が同じ記録は上書きされます</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <%= f.submit "取り込み", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
