<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h2">ユーザー一覧</h1>
  <%= link_to "新規ユーザー登録", new_admin_user_path, class: "btn btn-primary" %>
</div>

<!-- 検索・フィルターフォーム -->
<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: admin_users_path, method: :get, local: true, class: "row g-3" do |f| %>
      <div class="col-md-3">
        <%= f.text_field :search, class: "form-control", placeholder: "名前、メールアドレス、ユーザーIDで検索", value: params[:search] %>
      </div>
      <div class="col-md-2">
        <%= f.select :role_id, options_from_collection_for_select(Role.all, :id, :name, params[:role_id]),
                     { prompt: "役割で絞り込み" }, class: "form-select" %>
      </div>
      <div class="col-md-3">
        <%= f.select :hospital_id, options_from_collection_for_select(Hospital.all, :id, :name, params[:hospital_id]),
                     { prompt: "病院で絞り込み" }, class: "form-select" %>
      </div>
      <div class="col-md-2">
        <%= f.select :user_type, options_for_select([
                       ['すべて', ''],
                       ['患者', 'patient'],
                       ['医療従事者', 'medical_staff']
                     ], params[:user_type]), {}, class: "form-select" %>
      </div>
      <div class="col-md-2">
        <%= f.submit "検索", class: "btn btn-primary w-100" %>
      </div>
    <% end %>
  </div>
</div>

<!-- ユーザー一覧テーブル -->
<div class="card">
  <div class="card-body">
    <% if @users.any? %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>ユーザーID</th>
              <th>名前</th>
              <th>メールアドレス</th>
              <th>役割</th>
              <th>登録病院数</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <% @users.each do |user| %>
              <tr>
                <td><%= user.user_id %></td>
                <td><%= user.name %></td>
                <td><%= user.email %></td>
                <td>
                  <% user_roles = user.user_hospital_roles.includes(:role).distinct %>
                  <% user_roles.each do |user_role| %>
                    <% if !user_role.role.is_hospital_role %>
                      <span class="badge bg-danger"><%= user_role.role.name %></span>
                    <% elsif user_role.role.is_hospital_role && !user_role.role.is_medical_staff %>
                      <span class="badge bg-info"><%= user_role.role.name %></span>
                    <% else %>
                      <span class="badge bg-success"><%= user_role.role.name %></span>
                    <% end %>
                  <% end %>
                </td>
                <td><%= user.hospitals.distinct.count %></td>
                <td>
                  <%= link_to "詳細", admin_user_path(user), class: "btn btn-sm btn-info" %>
                  <%= link_to "編集", edit_admin_user_path(user), class: "btn btn-sm btn-warning" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- ページネーション -->
      <div class="mt-3">
        <%= paginate @users %>
      </div>
    <% else %>
      <p class="text-muted text-center py-4">ユーザーが登録されていません。</p>
    <% end %>
  </div>
</div>
