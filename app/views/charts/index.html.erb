<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h2">血圧推移グラフ</h1>
  <%= link_to "← 血圧記録に戻る", blood_pressure_records_path, class: "btn btn-secondary" %>
</div>

<!-- 期間選択 -->
<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title mb-3">表示期間</h5>
    <div class="d-flex gap-2 flex-wrap">
      <%= link_to "全て", charts_path(period: 'all'), 
                  class: "btn flex-fill #{'btn-primary' if @period == 'all'} #{'btn-outline-primary' if @period != 'all'}" %>
      <%= link_to "1ヶ月", charts_path(period: 'month'), 
                  class: "btn flex-fill #{'btn-success' if @period == 'month'} #{'btn-outline-success' if @period != 'month'}" %>
      <%= link_to "1週間", charts_path(period: 'week'), 
                  class: "btn flex-fill #{'btn-info' if @period == 'week'} #{'btn-outline-info' if @period != 'week'}" %>
    </div>
  </div>
</div>

<!-- 月・週のナビゲーション -->
<% if @period == 'month' %>
  <div class="card mb-4">
    <div class="card-body">
      <!-- 月選択セレクトボックス -->
      <div class="row mb-3">
        <div class="col-md-6 mx-auto">
          <%= form_with url: charts_path, method: :get, local: true, class: "row g-2" do |f| %>
            <%= f.hidden_field :period, value: 'month' %>
            <div class="col-5">
              <%= f.select :year, 
                          ((Time.current.year - 5)..(Time.current.year)).to_a.reverse,
                          { selected: @year },
                          { class: "form-select", onchange: "this.form.submit()" } %>
            </div>
            <div class="col-5">
              <%= f.select :month,
                          (1..12).map { |m| ["#{m}月", m] },
                          { selected: @month },
                          { class: "form-select", onchange: "this.form.submit()" } %>
            </div>
            <div class="col-2">
              <%= f.submit "表示", class: "btn btn-primary w-100" %>
            </div>
          <% end %>
        </div>
      </div>
      
      <!-- 前月・次月ナビゲーション -->
      <div class="d-flex justify-content-center align-items-center gap-2">
        <% prev_month = @month == 1 ? 12 : @month - 1 %>
        <% prev_year = @month == 1 ? @year - 1 : @year %>
        <%= link_to "← 前月", charts_path(period: 'month', year: prev_year, month: prev_month), 
                    class: "btn btn-sm btn-outline-secondary" %>
        
        <div class="text-center px-3">
          <h5 class="mb-0">
            <%= @year %>年<%= @month %>月
            <small class="text-muted d-block d-md-inline ms-md-2">
              (<%= @month_start.strftime("%m/%d") %> 〜 <%= @month_end.strftime("%m/%d") %>)
            </small>
          </h5>
        </div>
        
        <% next_month = @month == 12 ? 1 : @month + 1 %>
        <% next_year = @month == 12 ? @year + 1 : @year %>
        <%= link_to "次月 →", charts_path(period: 'month', year: next_year, month: next_month), 
                    class: "btn btn-sm btn-outline-secondary #{'disabled' if @is_current_month}",
                    disabled: @is_current_month %>
      </div>
    </div>
  </div>
<% elsif @period == 'week' %>
  <div class="card mb-4">
    <div class="card-body">
      <!-- 週選択セレクトボックス -->
      <div class="row mb-3">
        <div class="col-md-6 mx-auto">
          <%= form_with url: charts_path, method: :get, local: true, class: "row g-2" do |f| %>
            <%= f.hidden_field :period, value: 'week' %>
            <div class="col-10">
              <%= f.select :week_offset,
                          (-12..0).to_a.reverse.map { |offset|
                            week_start = Time.current.beginning_of_week(:monday) + offset.weeks
                            week_end = week_start.end_of_week(:sunday)
                            label = if offset == 0
                                      "今週 (#{week_start.strftime('%m/%d')} 〜 #{week_end.strftime('%m/%d')})"
                                    else
                                      "#{week_start.strftime('%Y年%m/%d')} 〜 #{week_end.strftime('%m/%d')}"
                                    end
                            [label, offset]
                          },
                          { selected: @week_offset },
                          { class: "form-select", onchange: "this.form.submit()" } %>
            </div>
            <div class="col-2">
              <%= f.submit "表示", class: "btn btn-primary w-100" %>
            </div>
          <% end %>
        </div>
      </div>
      
      <!-- 前週・次週ナビゲーション -->
      <div class="d-flex justify-content-center align-items-center gap-2">
        <%= link_to "← 前週", charts_path(period: 'week', week_offset: @week_offset - 1), 
                    class: "btn btn-sm btn-outline-secondary" %>
        
        <div class="text-center px-3">
          <h5 class="mb-0">
            <%= @week_start.strftime("%Y年%m月%d日") %>（月）〜 <%= @week_end.strftime("%m月%d日") %>（日）
          </h5>
        </div>
        
        <%= link_to "次週 →", charts_path(period: 'week', week_offset: @week_offset + 1), 
                    class: "btn btn-sm btn-outline-secondary #{'disabled' if @is_current_week}",
                    disabled: @is_current_week %>
      </div>
    </div>
  </div>
<% end %>

<!-- グラフ表示エリア -->
<div class="row" 
     data-controller="chart" 
     data-chart-data-value="<%= @chart_data.to_json %>">
  <!-- 血圧グラフ -->
  <div class="col-12 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">血圧推移</h5>
      </div>
      <div class="card-body">
        <div style="position: relative; height: 400px;">
          <canvas data-chart-target="bloodPressure"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 脈拍グラフ -->
  <div class="col-12 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">脈拍推移</h5>
      </div>
      <div class="card-body">
        <div style="position: relative; height: 300px;">
          <canvas data-chart-target="pulse"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- データがない場合の表示 -->
<% if @blood_pressure_records.empty? %>
  <div class="card">
    <div class="card-body text-center py-5">
      <p class="text-muted mb-3">
        <%= case @period
            when 'week' then '1週間以内'
            when 'month' then '1ヶ月以内'  
            else '現在'
            end %>の血圧記録がありません。
      </p>
      <%= link_to "血圧記録を追加", new_blood_pressure_record_path, class: "btn btn-primary" %>
    </div>
  </div>
<% end %>

<!-- Stimulusコントローラーでグラフを管理するため、JavaScriptコードは不要 -->
