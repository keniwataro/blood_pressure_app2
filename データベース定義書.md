# 血圧管理アプリケーション データベース定義書

## 概要

本データベースは、血圧管理アプリケーションのデータを管理するためのPostgreSQLデータベースです。
患者・医療従事者・システム管理者による役割分担型のシステムをサポートしています。

## テーブル一覧

| テーブル名 | 説明 | 主な用途 |
|-----------|------|----------|
| `users` | ユーザー情報 | 全ユーザーの基本情報管理 |
| `roles` | 役割情報 | 患者・医療従事者などの役割定義 |
| `hospitals` | 病院情報 | 病院の基本情報管理 |
| `user_hospital_roles` | ユーザー役割関連 | ユーザー・病院・役割の多対多関連 |
| `blood_pressure_records` | 血圧記録 | 患者の血圧測定データ |
| `patient_staff_assignments` | 患者スタッフ割り当て | 患者と担当スタッフの関連 |

## 詳細テーブル定義

### 1. users (ユーザー情報)

ユーザーの基本情報と認証情報を管理するテーブルです。

| カラム名 | データ型 | NULL | デフォルト | 説明 | 制約/インデックス |
|----------|----------|------|-----------|------|------------------|
| `id` | bigint | NO | - | 主キー | PRIMARY KEY |
| `email` | varchar | NO | '' | メールアドレス | UNIQUE INDEX |
| `encrypted_password` | varchar | NO | '' | 暗号化されたパスワード | - |
| `reset_password_token` | varchar | YES | - | パスワードリセットトークン | UNIQUE INDEX |
| `reset_password_sent_at` | timestamp | YES | - | パスワードリセット送信日時 | - |
| `remember_created_at` | timestamp | YES | - | リメンバートークン作成日時 | - |
| `created_at` | timestamp | NO | - | 作成日時 | - |
| `updated_at` | timestamp | NO | - | 更新日時 | - |
| `name` | varchar | YES | - | ユーザー名 | - |
| `user_id` | varchar | YES | - | ログイン用ユーザーID | UNIQUE INDEX |
| `current_role_id` | bigint | NO | - | 現在の役割ID | FOREIGN KEY (roles.id) |

**外部キー制約:**
- `current_role_id` → `roles.id`

**関連性:**
- `has_many :blood_pressure_records` (1:N)
- `has_many :user_hospital_roles` (1:N)
- `has_many :hospitals, through: :user_hospital_roles` (N:N)
- `has_many :roles, through: :user_hospital_roles` (N:N)
- `belongs_to :current_role, class_name: 'Role'` (N:1)

**備考:**
- Devise gemを使用した認証機能を実装
- メールアドレスはオプション（user_idでのログインをメインとする）

### 2. roles (役割情報)

システムで定義される役割（患者、医師、看護師など）を管理するテーブルです。

| カラム名 | データ型 | NULL | デフォルト | 説明 | 制約/インデックス |
|----------|----------|------|-----------|------|------------------|
| `id` | bigint | NO | - | 主キー | PRIMARY KEY |
| `name` | varchar | NO | - | 役割名 | UNIQUE INDEX |
| `is_medical_staff` | boolean | NO | false | 医療従事者フラグ | - |
| `description` | varchar | YES | - | 役割の説明 | - |
| `created_at` | timestamp | NO | - | 作成日時 | - |
| `updated_at` | timestamp | NO | - | 更新日時 | - |
| `is_hospital_role` | boolean | NO | true | 病院関連役割フラグ | - |

**関連性:**
- `has_many :user_hospital_roles` (1:N)
- `has_many :users, through: :user_hospital_roles` (N:N)
- `has_many :hospitals, through: :user_hospital_roles` (N:N)

**備考:**
- `is_medical_staff`: trueの場合、医療従事者（医師、看護師など）
- `is_hospital_role`: falseの場合、システム管理者などのグローバル役割

### 3. hospitals (病院情報)

病院の基本情報を管理するテーブルです。

| カラム名 | データ型 | NULL | デフォルト | 説明 | 制約/インデックス |
|----------|----------|------|-----------|------|------------------|
| `id` | bigint | NO | - | 主キー | PRIMARY KEY |
| `name` | varchar | YES | - | 病院名 | - |
| `address` | text | YES | - | 住所 | - |
| `phone_number` | varchar | YES | - | 電話番号 | - |
| `website` | varchar | YES | - | ウェブサイトURL | - |
| `created_at` | timestamp | NO | - | 作成日時 | - |
| `updated_at` | timestamp | NO | - | 更新日時 | - |

**関連性:**
- `has_many :user_hospital_roles` (1:N)
- `has_many :users, through: :user_hospital_roles` (N:N)
- `has_many :roles, through: :user_hospital_roles` (N:N)

**備考:**
- ID=1はシステム管理用の特別な病院として使用

### 4. user_hospital_roles (ユーザー役割関連)

ユーザー・病院・役割の多対多関連を管理する中間テーブルです。

| カラム名 | データ型 | NULL | デフォルト | 説明 | 制約/インデックス |
|----------|----------|------|-----------|------|------------------|
| `id` | bigint | NO | - | 主キー | PRIMARY KEY |
| `user_id` | bigint | NO | - | ユーザーID | FOREIGN KEY, INDEX |
| `hospital_id` | bigint | NO | - | 病院ID | FOREIGN KEY, INDEX |
| `role_id` | bigint | NO | - | 役割ID | FOREIGN KEY, INDEX |
| `created_at` | timestamp | NO | - | 作成日時 | - |
| `updated_at` | timestamp | NO | - | 更新日時 | - |
| `permission_level` | integer | NO | 0 | 権限レベル | INDEX |

**外部キー制約:**
- `user_id` → `users.id`
- `hospital_id` → `hospitals.id`
- `role_id` → `roles.id`

**ユニーク制約:**
- `(user_id, hospital_id, role_id)`: 同じユーザー・病院・役割の組み合わせは一意

**関連性:**
- `belongs_to :user` (N:1)
- `belongs_to :hospital` (N:1)
- `belongs_to :role` (N:1)

**備考:**
- `permission_level`: enum定義（general: 0, administrator: 1）
- 医療従事者の役割でpermission_level=1の場合、病院管理者権限を持つ

### 5. blood_pressure_records (血圧記録)

患者の血圧測定データを管理するテーブルです。

| カラム名 | データ型 | NULL | デフォルト | 説明 | 制約/インデックス |
|----------|----------|------|-----------|------|------------------|
| `id` | bigint | NO | - | 主キー | PRIMARY KEY |
| `user_id` | bigint | NO | - | 患者ユーザーID | FOREIGN KEY, INDEX |
| `systolic_pressure` | integer | YES | - | 収縮期血圧(mmHg) | - |
| `diastolic_pressure` | integer | YES | - | 拡張期血圧(mmHg) | - |
| `pulse_rate` | integer | YES | - | 脈拍数(回/分) | - |
| `measured_at` | timestamp | YES | - | 測定日時 | - |
| `memo` | text | YES | - | メモ | - |
| `created_at` | timestamp | NO | - | 作成日時 | - |
| `updated_at` | timestamp | NO | - | 更新日時 | - |

**外部キー制約:**
- `user_id` → `users.id`

**関連性:**
- `belongs_to :user` (N:1)

**備考:**
- 血圧記録は患者（user_idを持つユーザー）のみが作成可能

### 6. patient_staff_assignments (患者スタッフ割り当て)

患者と担当医療従事者の関連を管理するテーブルです。

| カラム名 | データ型 | NULL | デフォルト | 説明 | 制約/インデックス |
|----------|----------|------|-----------|------|------------------|
| `id` | bigint | NO | - | 主キー | PRIMARY KEY |
| `patient_id` | bigint | NO | - | 患者ユーザーID | FOREIGN KEY, INDEX |
| `staff_id` | bigint | NO | - | スタッフユーザーID | FOREIGN KEY, INDEX |
| `hospital_id` | bigint | NO | - | 病院ID | FOREIGN KEY, INDEX |
| `created_at` | timestamp | NO | - | 作成日時 | - |
| `updated_at` | timestamp | NO | - | 更新日時 | - |

**外部キー制約:**
- `patient_id` → `users.id`
- `staff_id` → `users.id`
- `hospital_id` → `hospitals.id`

**ユニーク制約:**
- `(patient_id, staff_id, hospital_id)`: 同じ患者・スタッフ・病院の組み合わせは一意

**関連性:**
- `belongs_to :patient, class_name: 'User'` (N:1)
- `belongs_to :staff, class_name: 'User'` (N:1)
- `belongs_to :hospital` (N:1)

**備考:**
- 患者と医療従事者の担当関係を病院ごとに管理
- 患者は複数のスタッフに、スタッフは複数の患者を担当可能

## データモデル図

```
Users (患者・医療従事者・システム管理者)
├── 1:N → Blood Pressure Records (血圧記録)
├── N:N → Roles (役割) [through User Hospital Roles]
├── N:N → Hospitals (病院) [through User Hospital Roles]
└── N:1 → Current Role (現在の役割)

Roles (役割: 患者/医師/看護師/システム管理者)
├── N:N → Users [through User Hospital Roles]
└── N:N → Hospitals [through User Hospital Roles]

Hospitals (病院)
├── N:N → Users [through User Hospital Roles]
└── N:N → Roles [through User Hospital Roles]

User Hospital Roles (ユーザー・病院・役割関連)
├── 権限レベル管理 (general/administrator)
└── 多対多関連の中間テーブル

Patient Staff Assignments (患者・スタッフ割り当て)
├── 患者と医療従事者の担当関係管理
└── 病院ごとの割り当て管理
```

## インデックス

### パフォーマンスインデックス
- `users.email` (unique)
- `users.user_id` (unique)
- `users.reset_password_token` (unique)
- `users.current_role_id`
- `roles.name` (unique)
- `user_hospital_roles.user_id`
- `user_hospital_roles.hospital_id`
- `user_hospital_roles.role_id`
- `user_hospital_roles.permission_level`
- `blood_pressure_records.user_id`
- `patient_staff_assignments.patient_id`
- `patient_staff_assignments.staff_id`
- `patient_staff_assignments.hospital_id`

### ユニークインデックス
- `users.email`
- `users.user_id`
- `users.reset_password_token`
- `roles.name`
- `user_hospital_roles(user_id, hospital_id, role_id)`
- `patient_staff_assignments(patient_id, staff_id, hospital_id)`

## 制約とバリデーション

### NOT NULL制約
- 主キー: すべてNOT NULL
- 外部キー: すべてNOT NULL
- 必須項目: email, encrypted_password, current_role_id, permission_level など

### ユニーク制約
- `users.email`: メールアドレスの一意性
- `users.user_id`: ユーザーIDの一意性
- `roles.name`: 役割名の一意性
- `user_hospital_roles(user_id, hospital_id, role_id)`: ユーザー・病院・役割の組み合わせ一意性
- `patient_staff_assignments(patient_id, staff_id, hospital_id)`: 患者・スタッフ・病院の組み合わせ一意性

### 外部キー制約
- すべての関連テーブル間で外部キー制約を実装
- CASCADE DELETE は使用せず、アプリケーション側で依存関係を管理

## 初期データ

### システム初期データ
- システム管理者役割 (ID: 1)
- システム管理病院 (ID: 1)
- システム管理者アカウント

### サンプルデータ
- 複数の病院データ
- 各種役割データ（患者、医師、看護師など）
- サンプルユーザーと役割割り当て

## マイグレーション履歴

### 主要マイグレーション
1. 初期テーブル作成 (users, roles, hospitals, blood_pressure_records)
2. 多対多関連テーブル追加 (user_hospital_roles)
3. 権限レベル追加 (permission_level)
4. 患者スタッフ割り当て機能追加 (patient_staff_assignments)
5. 役割分類追加 (is_medical_staff, is_hospital_role)

## 注意事項

- PostgreSQL固有の機能（plpgsql）を有効化
- enum型はRubyモデルで定義（DBレベルではinteger）
- 外部キー制約はアプリケーションの整合性を保証
- 論理削除は実装せず、物理削除を使用
